<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disdrive</title>
  <link rel="stylesheet" href="styles.css">
  <script>
    function deleteFile(fileName) {
      fetch('/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fileName })
        })
        .then((response) => {
          if (response.ok) {
            window.location.reload();
          } else {
            console.error('Failed to delete file');
          }
        })
        .catch((error) => {
          console.error(error);
        });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://unpkg.com/simplebar@latest/dist/simplebar.css" />
  <script src="https://unpkg.com/simplebar@latest/dist/simplebar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>

<body>
  <div class="sd-tabs" dark>
    <input class="sd-tab-radio" tabindex="1" name="tabs" type="radio" id="tabone" checked="checked">
    <label class="sd-tab-label" for="tabone">
      <div class="sd-tab-icon">
        <img src="./download.png" alt="icon">
      </div>
      <div class="sd-tab-desc">Uploads</div>
      <div class="sd-tab-icon sd-tab-close">
        <svg aria-hidden="true" data-prefix="fal" data-icon="times" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 320 512" class="svg-inline--fa fa-times fa-w-10 fa-2x">
          <path fill="currentColor"
            d="M193.94 256L296.5 153.44l21.15-21.15c3.12-3.12 3.12-8.19 0-11.31l-22.63-22.63c-3.12-3.12-8.19-3.12-11.31 0L160 222.06 36.29 98.34c-3.12-3.12-8.19-3.12-11.31 0L2.34 120.97c-3.12 3.12-3.12 8.19 0 11.31L126.06 256 2.34 379.71c-3.12 3.12-3.12 8.19 0 11.31l22.63 22.63c3.12 3.12 8.19 3.12 11.31 0L160 289.94 262.56 392.5l21.15 21.15c3.12 3.12 8.19 3.12 11.31 0l22.63-22.63c3.12-3.12 3.12-8.19 0-11.31L193.94 256z" />
        </svg>
      </div>
    </label>
    <div class="sd-tab-content" tabindex="1">
      <div class="file-new-section">
        <div class="file-new-button" id="fileNewButton">
          <img src="./new.png" alt="new">
          <p>New</p>
          <img src="./downarrow.png" class="down-arrow" alt="downarrow">
        </div>
        <div class="file-new-dropdown">
          <div class="file-new-dropdown-item" onclick="uploadFileButton()">
            <img src="./upload.png" alt="upload">
            Upload Files
          </div>
          <div class="file-new-dropdown-item">
            <img src="./folder.png" alt="folder">
            Folder
          </div>
        </div>
        <div class="line-breaker-vertical"></div>
        <div class="file-new-item cut">
          <img src="scissors.png" alt="scissors">
          <div class="tooltip">Cut</div>
        </div>
        <div class="file-new-item copy">
          <img src="copy.png" alt="copy">
          <div class="tooltip">Copy</div>
        </div>
        <div class="file-new-item paste">
          <img src="paste.png" alt="paste">
          <div class="tooltip">Paste</div>
        </div>
        <div class="file-new-item rename">
          <img src="rename.png" alt="rename">
          <div class="tooltip">Rename</div>
        </div>
        <div class="file-new-item share">
          <img src="share.png" alt="share">
          <div class="tooltip">Share</div>
        </div>
        <div class="file-new-item trash">
          <img src="trash.png" alt="trash">
          <div class="tooltip">Delete</div>
        </div>
      </div>
      <div class="line-breaker"></div>
      <div class="nav-bar">
        <div class="nav-bar-item">
          <img src="./back.png" alt="back">
          <div class="tooltip">Back</div>
        </div>
        <div class="nav-bar-item">
          <img src="./forward.png" alt="forward">
          <div class="tooltip">Forward</div>
        </div>
        <div class="nav-bar-item">
          <img class="small" src="./down.png" alt="down">
          <div class="tooltip">Recent Locations</div>
        </div>
        <div class="nav-bar-item">
          <img src="./up.png" alt="up">
          <div class="tooltip">Up "idk what this does."</div>
        </div>
        <div class="path-box" onclick="textBox()">
          <img src="./download.png" alt="uploads">
          <img src="./right.png" class="small bold right-arrow" alt="right">
          <span class="path">uploads</span>
        </div>        
      </div>
      <div class="files-info">
        <div class="side-bar" id="simple-bar">
          <div class="side-bar-item selected">
            <img src="./home.png" alt="upload">
            <p>Home</p>
          </div>
          <div data-simplebar></div>
        </div>
        <div class="line-breaker-vertical-full"></div>
        <div class="files-section">
          ${filesHTML}
        </div>
      </div>
    </div>
  </div>
  <section id="progress-section"></section>
</body>
</html>
<script>
new SimpleBar(document.getElementById('simple-bar'), { autoHide: false });
const fileNewButton = document.getElementById('fileNewButton');
const fileNewDropdown = document.querySelector('.file-new-dropdown');

fileNewButton.addEventListener('click', toggleDropdown);

function toggleDropdown() {
fileNewDropdown.style.display = fileNewDropdown.style.display === 'block' ? 'none' : 'block';
}
let focusedFile = null;

function handleFileFocus(event) {
const fileElement = event.currentTarget;

// Remove focus from previously focused file
if (focusedFile) {
  focusedFile.classList.remove('file-focused');
  const items = document.querySelectorAll('.file-new-item');
  items.forEach((item) => {
    item.style.opacity = '0.5';
  });
}

// Apply focus to the clicked file
fileElement.classList.add('file-focused');
focusedFile = fileElement;

const items = document.querySelectorAll('.file-new-item');
items.forEach((item) => {
  item.style.opacity = '1';
});

// Prevent event propagation to avoid triggering other click events
event.stopPropagation();
}  

document.addEventListener('click', handleDocumentClick);

function handleDocumentClick(event) {
const filesSection = document.querySelector('.files-section');
const isClickInsideFiles = filesSection.contains(event.target);

if (!isClickInsideFiles && focusedFile) {
  focusedFile.classList.remove('file-focused');
  const items = document.querySelectorAll('.file-new-item');
  items.forEach((item) => {
    item.style.opacity = '0.5';
  });
  focusedFile = null;
}
}  
window.addEventListener('beforeunload', () => {
document.removeEventListener('click', handleDocumentClick);
});
const config = {
    FORBID_TAGS: ['script'],
  };

  function textBox() {
    const pathBox = document.querySelector('.path-box');
    const path = pathBox.querySelector('.path');
    if (!path) return;

    const textBox = document.createElement('input');
    textBox.id = 'pathInput';
    textBox.type = 'text';
    textBox.value = path.textContent || path.innerText;
    pathBox.replaceChild(textBox, path);
    textBox.focus();

    textBox.addEventListener('keyup', handleEnterKey);
    pathBox.removeEventListener('click', textBoxClick);
    pathBox.classList.add('input-active');
  }

  function handleEnterKey(event) {
    if (event.key === 'Enter') {
      const sanitizedValue = DOMPurify.sanitize(event.target.value, config);
      const path = document.createElement('span');
      path.className = 'path';
      path.innerHTML = sanitizedValue;
      const textBox = document.querySelector('#pathInput');
      const pathBox = document.querySelector('.path-box');
      pathBox.replaceChild(path, textBox);
      pathBox.addEventListener('click', textBoxClick);
      pathBox.classList.remove('input-active');
    }
  }

  function textBoxClick(event) {
    const pathBox = document.querySelector('.path-box');
    const textBox = document.querySelector('#pathInput');
    const isClickInsidePathBox = pathBox.contains(event.target);
    const isClickInsideTextBox = textBox.contains(event.target);

    if (!isClickInsidePathBox && !isClickInsideTextBox) {
      const sanitizedValue = DOMPurify.sanitize(textBox.value, config);
      const path = document.createElement('span');
      path.className = 'path';
      path.innerHTML = sanitizedValue;
      pathBox.replaceChild(path, textBox);
      pathBox.addEventListener('click', textBoxClick);
      pathBox.classList.remove('input-active');
    }
  }

  const pathBox = document.querySelector('.path-box');
  pathBox.addEventListener('click', textBoxClick);

document.addEventListener('click', function(event) {
const isClickInsideDropdown = fileNewDropdown.contains(event.target);
const isClickInsideButton = fileNewButton.contains(event.target);

if (!isClickInsideDropdown && !isClickInsideButton) {
  fileNewDropdown.style.display = 'none';
}
});
const fileNewTrashIcon = document.querySelector('.trash');
fileNewTrashIcon.addEventListener('click', deleteFocusedFile);

function deleteFocusedFile() {
const focusedFile = document.querySelector('.file.file-focused');
if (focusedFile) {
  const name = focusedFile.getAttribute('data-name');
  deleteFile(name);
}
}


function uploadFileButton() {
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.click();

fileInput.addEventListener('change', (event) => {
  const selectedFile = event.target.files[0];
  if (selectedFile) {
    uploadFile(selectedFile);
  }
});
}

const progressSection = document.getElementById('progress-section');

function createProgressBar(id, title) {
const progressDiv = document.createElement('div');
progressDiv.setAttribute('id', `${id}-div`);
progressDiv.innerHTML = `
  <p>${title}</p>
  <div class="progress-bar progress-bar-show-percent">
    <div id="${id}-progress-bar" class="progress-bar-filled" style="width: 0" data-filled="Progress 0%"></div>
  </div>
  `;
progressSection.appendChild(progressDiv);
}

function updateProgressBar(id, percent) {
const progressBar = document.getElementById(`${id}-progress-bar`);
progressBar.style.width = `${percent}%`;
progressBar.setAttribute('data-filled', `Progress ${percent}%`);
}

function deleteProgressBar(id, timeout = 3000) {
const progressDiv = document.getElementById(`${id}-div`);
setTimeout(() => progressSection.removeChild(progressDiv), timeout);
}

function makeid(length) {
let result = '';
const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
const charactersLength = characters.length;
for (let i = 0; i < length; i += 1) {
  result += characters.charAt(Math.floor(Math.random() * charactersLength));
}
return result;
}

function uploadFile(file) {
if (!file) {
  return;
}

const id = makeid(20);
const formData = new FormData();
formData.append('file', file);

createProgressBar(id, `Uploading ${file.name}`);
const xhr = new XMLHttpRequest();
xhr.open('POST', '/upload');

xhr.upload.addEventListener('progress', (e) => {
  if (e.lengthComputable) {
    const progress = (e.loaded / e.total) * 100;
    updateProgressBar(id, Math.floor(progress));
  }
});

xhr.onload = async () => {
  deleteProgressBar(id);
};

xhr.onerror = async () => {
  deleteProgressBar(id);
};

xhr.send(formData);
}
</script>
<noscript>
<style>
/**
* Reinstate scrolling for non-JS clients
*/
.simplebar-content-wrapper {
  scrollbar-width: auto;
  -ms-overflow-style: auto;
}

.simplebar-content-wrapper::-webkit-scrollbar,
.simplebar-hide-scrollbar::-webkit-scrollbar {
  display: initial;
  width: initial;
  height: initial;
}
</style>
</noscript>
</body>
</html>